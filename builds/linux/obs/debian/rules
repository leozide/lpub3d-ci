#!/usr/bin/make -f
# -*- makefile -*-
# Copyright 2017 Trevor SANDY

# output every command that modifies files on the build system.
export DH_VERBOSE=1

# use Qt5
export QT_SELECT=qt5

# for 3rd party apps install
export LP3D_CREATE_PKG=yes

# get target arch
LP3D_TARGET_ARCH=`uname -m`

# override these 3rd party dependency libs - related packages are defined in control and dsc
override_dh_shlibdeps:
	dh_shlibdeps --dpkg-shlibdeps-params=-xdebian/lpub3d-ci/opt/lpub3d/3rdParty/ldview-4.3/bin/ldview -xdebian/lpub3d-ci/opt/lpub3d/3rdParty/ldglite-1.3/bin/ldglit -xdebian/lpub3d-ci/opt/lpub3d/3rdParty/lpub3d_trace_cui-3.8/bin/lpub3d_trace_cui

%:
	dh $@

configure: configure-stamp
configure-stamp:
	dh_testdir

	# Start custom configuration commands
	echo "Current working directory: `pwd`"
	if [ -f ../SOURCES/complete.zip ]; then \
			cp ../SOURCES/complete.zip mainApp/extras; \
			echo "LDraw archive library complete.zip copied"; \
	else \
			echo "complete.zip not found at `pwd`!"; \
	fi
	if [ -f ../SOURCES/lpub3dldrawunf.zip ]; then \
			cp ../SOURCES/lpub3dldrawunf.zip mainApp/extras; \
			echo "LDraw archive library lpub3dldrawunf.zip copied"; \
	else \
			echo "lpub3dldrawunf.zip not found at `pwd`!"; \
	fi
	if [ -f ../SOURCES/lpub3d_linux_3rdparty.tar.gz ]; then \
			mkdir -p ../lpub3d_linux_3rdparty && tar -xzf ../SOURCES/lpub3d_linux_3rdparty.tar.gz -C ../lpub3d_linux_3rdparty --strip-components=1; \
			echo "lpub3d_linux_3rdparty tarball extracted to ../lpub3d_linux_3rdparty/"; \
			rm -f ../SOURCES/lpub3d_linux_3rdparty.tar.gz && echo "lpub3d_linux_3rdparty.tar.gz tarball deleted"; \
	else \
			echo "lpub3d_linux_3rdparty tarball not found at `pwd`!"; \
	fi
	FILE="builds/linux/obs/debian/source/include-binaries" \
	&& sed -i -e "s/__arch__/${LP3D_TARGET_ARCH}/g" "$$FILE" \
	&& echo "updated arch ${LP3D_TARGET_ARCH} in `pwd`/$$FILE"
override_dh_auto_configure:
	if [ "${LP3D_TARGET_ARCH}" = "x86_64" ]; then \
		/usr/lib/x86_64-linux-gnu/qt5/bin/qmake -v; \
		/usr/lib/x86_64-linux-gnu/qt5/bin/qmake -makefile -nocache QMAKE_STRIP=: CONFIG+=release CONFIG+=deb;	\
	else \
		/usr/lib/i386-linux-gnu/qt5/bin/qmake -v; \
		/usr/lib/i386-linux-gnu/qt5/bin/qmake -makefile -nocache QMAKE_STRIP=: CONFIG+=release CONFIG+=deb; \
	fi
	# End custom configuration commands
	touch configure-stamp

build: configure-stamp

clean:
	dh_testdir
	dh_testroot
	rm -f configure-stamp

	dh_clean

.PHONY: configure build clean
