#!/bin/bash
#
# Travis build [release] procedures
#
#  Trevor SANDY <trevor.sandy@gmail.com>
#  Last Update: December 31, 2017
#  Copyright (c) 2017 by Trevor SANDY
#
cd $LP3D_BUILD_FOLDER

# GitHub release deployment
echo "Deploying to GitHub releases ...";
# Download release files from temp Dropbox store
if [ -f "/tmp/.dropbox_oauth" ]; then
  chmod +x "${LP3D_CI_DIR}/dropbox_uploader.sh";
  ./"${LP3D_CI_DIR}/dropbox_uploader.sh" list "$LP3D_DROPBOX_UPDATES_DIR";
  ./"${LP3D_CI_DIR}/dropbox_uploader.sh" download /"$LP3D_DROPBOX_UPDATES_DIR" "$LP3D_RELEASES_DIR"/;
  ./"${LP3D_CI_DIR}/dropbox_uploader.sh" list "$LP3D_DROPBOX_DOWNLOADS_DIR";
  ./"${LP3D_CI_DIR}/dropbox_uploader.sh" download /"$LP3D_DROPBOX_DOWNLOADS_DIR" "$LP3D_RELEASES_DIR"/;
else
  echo "ERROR - /tmp/.dropbox_oauth token file not found - cannot perform file download";
fi;
# Verify release files in the Download directory
if [ -n "$(find "$LP3D_DOWNLOADS_DIR" -maxdepth 0 -type d -empty 2>/dev/null)" ]; then
  echo "ERROR - $LP3D_DOWNLOADS_DIR folder is empty.";
  echo "GitHub release and Sourceforge.net download aborted.";
  export LP3D_DEPLOY_PKG=no;
else
  echo "LPub3D Download Assets:" && find $LP3D_DOWNLOADS_DIR -type f;
fi
# Verify release files in the Updates directory for Sourceforge upload
if [ -n "$(find "$LP3D_UPDATES_DIR" -maxdepth 0 -type d -empty 2>/dev/null)" ]; then
  echo "ERROR - $LP3D_UPDATES_DIR folder is empty.";
  echo "Sourceforge.net update release aborted.";
  export LP3D_DEPLOY_SF_PKG=no;
else
  echo "LPub3D Update Assets:" && find $LP3D_UPDATES_DIR -type f;
  export LP3D_DEPLOY_SF_PKG=yes;
fi
# Decrypt Sourceforge private key
[ "$TRAVIS_SECURE_ENV_VARS" == "false" ] || openssl aes-256-cbc -K $encrypted_cacf73a1954d_key -iv $encrypted_cacf73a1954d_iv -in ${LP3D_SECURE_DIR}/.sfdeploy_travis_rsa.enc -out /tmp/.sfdeploy_travis_rsa -d;
if [ -f "/tmp/.sfdeploy_travis_rsa" ]; then
  # add key to ssh-agent
  eval "$(ssh-agent -s)";
  chmod 600 /tmp/.sfdeploy_travis_rsa;
  ssh-add /tmp/.sfdeploy_travis_rsa;
else
  echo "ERROR - /tmp/.sfdeploy_travis_rsa not found - cannot perform Sourceforge.net transfers";
  export LP3D_DEPLOY_SF_PKG=no;
fi;

